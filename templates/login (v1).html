<!DOCTYPE html>
<html>
<head>
  <title>Login - Mi-Stack</title>
  <!-- Font Awesome for star icon -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-papHh5fZ4jU4rF5c3IGPLeuQH6pLgKZ6p7kn2APO+nX8J+7xVf3b+fZ+k5tZoJ5TZefp4XUQm52A6xmB5PBiIg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="icon" href="{{ url_for('static', filename='fav.png') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='login_style.css') }}">
<!-- GSAP + SplitType -->
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<script src="https://unpkg.com/split-type"></script>


</head>
<body>
  <div class="preloader">
    <canvas id="starfield"></canvas>
    <div class="galaxy">
      <i class="fas fa-star center-star"></i>
      <div class="orbit orbit1"><div class="planet"></div></div>
      <div class="orbit orbit2"><div class="planet"></div></div>
      <div class="orbit orbit3"><div class="planet"></div></div>
      <div class="orbit orbit4"><div class="planet"></div></div>
    </div>
    <div class="progress-container">
      <div class="progress-bar"></div>
    </div>
    <div class="percentage">0%</div>
  </div>
  
  <div class="overlay"></div>
  <div class="glass-container">
    <h2>Login to Mi-Stack</h2>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash {{ category }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    <form method="POST">
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <a href="{{ url_for('register') }}">Don't have an account? Register</a>
  </div>

  <script>
    window.addEventListener('load', () => {
      const width = window.innerWidth;
      const height = window.innerHeight;
      const rand = Math.floor(Math.random() * 1000); // avoid caching same image
      const url = `https://picsum.photos/${width}/${height}?random=${rand}`;
      document.body.style.backgroundImage = `url('${url}')`;
    });
    </script>

<script>
  // Init preloader
  const width = window.innerWidth;
  const height = window.innerHeight;
  const rand = Math.floor(Math.random() * 1000);
  const url = `https://picsum.photos/${width}/${height}?random=${rand}`;

  function updateProgress(p) {
    const clamped = Math.max(0, Math.min(100, p));
    const bar = document.querySelector(".preloader .progress-bar");
    const percEl = document.querySelector(".preloader .percentage");
    const pre = document.querySelector(".preloader");
    if (!bar || !percEl || !pre) return;
    bar.style.width = clamped + "%";
    percEl.textContent = clamped + "%";

    if (clamped >= 100) {
      setTimeout(() => {
        pre.classList.add("hidden");
        setTimeout(() => pre.remove(), 600);
      }, 300);
    }
  }

  // Fetch image with progress
  fetch(url)
    .then(res => {
      const total = parseInt(res.headers.get("Content-Length")) || 1000000;
      let loaded = 0;
      const reader = res.body.getReader();
      const chunks = [];
      return (function read() {
        return reader.read().then(({ done, value }) => {
          if (done) return new Blob(chunks);
          loaded += value.byteLength;
          chunks.push(value);
          updateProgress(Math.round((loaded / total) * 100));
          return read();
        });
      })();
    })
    .then(blob => {
      const bgUrl = URL.createObjectURL(blob);
      document.body.style.backgroundImage = `url('${bgUrl}')`;
    })
    .catch(err => {
      console.warn("Image load error", err);
    });

  // Starfield effect
  (function(){
    const canvas = document.getElementById('starfield');
    const ctx = canvas.getContext('2d');
    let w, h, stars = [];

    function resize() {
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
      stars = [];
      const count = Math.floor((w*h)/8000);
      for (let i = 0; i < count; i++) {
        stars.push({
          x: Math.random() * w,
          y: Math.random() * h,
          r: Math.random() * 1.2 + 0.3,
          phase: Math.random() * Math.PI * 2,
          speed: Math.random() * 0.0005 + 0.0002
        });
      }
    }

    function animate(time) {
      ctx.clearRect(0, 0, w, h);
      stars.forEach(s => {
        s.phase += s.speed * 16;
        const alpha = 0.5 + 0.5 * Math.sin(s.phase);
        ctx.fillStyle = `rgba(255,255,255,${alpha})`;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, 2 * Math.PI);
        ctx.fill();
      });
      requestAnimationFrame(animate);
    }

    window.addEventListener("resize", resize);
    resize();
    requestAnimationFrame(animate);
  })();
</script>

    
</body>
</html>
